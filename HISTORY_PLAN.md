# План доработки истории генераций — HH TextGen

## Текущие проблемы

- **Один слот** — `ad_results` хранит только последнюю генерацию, предыдущие затираются
- **Нет таймстемпов** — непонятно, когда текст был сгенерирован
- **Правки затирают оригинал** — после ручного редактирования исходный ответ модели теряется
- **Нет визуальной обратной связи** — пользователь не видит, что сохранено, а что нет

---

## Вариант A: Стек последних генераций с навигацией

**Суть:** Хранить последние N генераций (5–10) как массив. Навигация «← Предыдущая / Следующая →» между ними.

**Что хранится в `ad_history`:**
```json
[
  {
    "id": 1707600000000,
    "ts": "2025-02-11T12:00:00",
    "style": "balanced",
    "platforms": ["vk_universal", "yandex_search"],
    "description": "Оператор-кассир АЗС Газпромнефть...",
    "texts": [{ "system": "vk_universal", "headline": "...", "text": "..." }],
    "meta": "claude-sonnet-4-5... · 17.4s"
  }
]
```

**UI:** Компактная полоска под кнопкой «Сгенерировать»:
```
← 3 из 5 · 11 фев, 14:32 →   [Удалить]
```

**Плюсы:**
- Минимальные изменения UI — одна строка навигации
- Автоматически — пользователю не нужно ничего называть
- Старые генерации видны сразу, можно сравнить

**Минусы:**
- Лимит N записей — давние генерации всё равно теряются
- Нет группировки по вакансиям — всё в одном потоке

**Объём:** ~40 строк JS, ~10 строк CSS, ~5 строк HTML

---

## Вариант B: Именованные сессии (проекты)

**Суть:** Пользователь может сохранить текущее состояние (описание + площадки + стиль + результаты) как именованную сессию. Список сессий в выпадающем меню.

**Что хранится в `ad_sessions`:**
```json
{
  "АЗС Газпромнефть — кассир": {
    "ts": "2025-02-11T12:00:00",
    "style": "balanced",
    "platforms": ["vk_universal"],
    "description": "...",
    "texts": [...],
    "meta": "..."
  },
  "Курьер Яндекс Еда": { ... }
}
```

**UI:** Секция «Сессии» в шапке:
```
[Сохранить как...] [▼ Загрузить сессию]
```

**Плюсы:**
- Удобно для работы с несколькими вакансиями параллельно
- Явное действие «Сохранить» — пользователь контролирует, что хранится
- Название даёт контекст — легко найти нужную генерацию

**Минусы:**
- Требует действия от пользователя (назвать, нажать кнопку)
- Больше UI: модалка/попап для имени, выпадающий список сессий
- Сложнее реализация — CRUD для сессий

**Объём:** ~80 строк JS, ~30 строк CSS, ~15 строк HTML

---

## Вариант C: Автоматический лог + визуальная обратная связь (рекомендуемый)

**Суть:** Гибрид — каждая генерация автоматически попадает в историю (как A), но с привязкой к описанию вакансии. Плюс визуальный индикатор «Сохранено» с таймстемпом.

**Что хранится в `ad_history`:**
```json
[
  {
    "id": 1707600000000,
    "ts": "2025-02-11T12:00:00",
    "label": "Оператор-кассир АЗС Газпромн...",
    "style": "balanced",
    "platforms": ["vk_universal", "yandex_search"],
    "description": "...",
    "original_texts": [...],
    "texts": [...],
    "meta": "..."
  }
]
```

**Ключевые отличия:**
1. **`label`** — авто-генерируется из первых ~40 символов описания (или заголовка первого результата)
2. **`original_texts`** — сохраняет оригинал от модели, отдельно от `texts` (редактируемых)
3. **Визуальный статус** — под результатами: `✓ Сохранено · 11 фев, 14:32 · [Сбросить правки]`
4. **Боковая панель истории** — кнопка «История» в шапке, открывает список прошлых генераций

**UI — панель истории:**
```
┌─────────────────────────────┐
│ ИСТОРИЯ                  ✕  │
│                             │
│ ● Оператор-кассир АЗС...   │
│   11 фев, 14:32 · 8 текстов│
│                             │
│ ○ Курьер Яндекс Еда        │
│   10 фев, 09:15 · 3 текста │
│                             │
│ ○ SMM-менеджер hh.ru        │
│   09 фев, 16:40 · 5 текстов│
└─────────────────────────────┘
```

**UI — статус под результатами:**
```
✓ Сохранено · 11 фев, 14:32 · Изменено   [Сбросить правки]
```

**Плюсы:**
- Автоматически — ничего не нужно называть вручную
- Оригинал сохранён — можно сбросить правки к исходному тексту модели
- Визуальная обратная связь — всегда видно, что и когда сохранено
- Группировка по вакансиям через label
- Лимит 20 записей — автоудаление самых старых

**Минусы:**
- Самый большой объём работы из трёх вариантов
- Панель истории добавляет UI-сложность

**Объём:** ~120 строк JS, ~50 строк CSS, ~20 строк HTML

---

## Сравнение

| Критерий | A: Стек | B: Сессии | C: Лог + статус |
|----------|---------|-----------|-----------------|
| Автоматизм | полный | ручной | полный |
| Поиск по вакансиям | нет | да (по имени) | да (по label) |
| Сохранение оригинала | нет | нет | да |
| Визуальная обратная связь | минимальная | есть | полная |
| Объём работы | малый | средний | большой |
| Решает проблему «что сохранено?» | частично | да | да |

---

## Рекомендация

**Вариант C** решает все выявленные проблемы: автоматическая история, привязка к вакансии, сохранение оригинала, визуальный статус. Если нужно быстрее — **Вариант A** даёт 80% пользы за 30% усилий.
