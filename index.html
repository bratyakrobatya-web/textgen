<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HH TextGen</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --surface2: #0f3460;
            --accent: #e94560;
            --text: #eee;
            --text2: #aab;
            --radius: 12px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 16px 20px;
            background: var(--surface);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        header h1 { font-size: 18px; font-weight: 600; flex: 1; }
        .settings-btn {
            background: none; border: none; color: var(--text2);
            cursor: pointer; font-size: 22px; padding: 4px;
        }
        .settings-btn:hover { color: var(--text); }

        /* Settings panel */
        .settings {
            background: var(--surface);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 16px 20px;
            display: none;
            flex-shrink: 0;
        }
        .settings.open { display: block; }
        .settings label { display: block; font-size: 13px; color: var(--text2); margin-bottom: 4px; }
        .settings input, .settings select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 12px;
        }
        .settings select { appearance: none; cursor: pointer; }
        .token-saved { color: #4ade80; font-size: 12px; display: none; margin-left: 8px; }

        /* Chat area */
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: var(--radius);
            line-height: 1.5;
            font-size: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .msg.user {
            align-self: flex-end;
            background: var(--surface2);
            border-bottom-right-radius: 4px;
        }
        .msg.assistant {
            align-self: flex-start;
            background: var(--surface);
            border-bottom-left-radius: 4px;
        }
        .msg .meta {
            font-size: 11px;
            color: var(--text2);
            margin-top: 8px;
        }
        .msg.error {
            align-self: center;
            background: rgba(233,69,96,0.15);
            border: 1px solid var(--accent);
            color: #f87171;
            font-size: 13px;
        }
        .typing {
            align-self: flex-start;
            color: var(--text2);
            font-size: 14px;
            padding: 12px 16px;
        }
        .typing::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Welcome */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text2);
            text-align: center;
            gap: 8px;
        }
        .welcome .icon { font-size: 48px; margin-bottom: 8px; }
        .welcome h2 { color: var(--text); font-size: 20px; }
        .welcome p { font-size: 14px; max-width: 300px; }

        /* Input */
        .input-area {
            padding: 12px 20px 20px;
            background: var(--surface);
            border-top: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }
        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        #prompt {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 48px;
            max-height: 160px;
            line-height: 1.4;
        }
        #prompt:focus { outline: none; border-color: var(--accent); }
        #prompt::placeholder { color: var(--text2); }
        #sendBtn {
            padding: 12px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        #sendBtn:hover { filter: brightness(1.1); }
        #sendBtn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body>

<header>
    <h1>HH TextGen</h1>
    <button class="settings-btn" onclick="toggleSettings()" title="Настройки">⚙</button>
</header>

<div class="settings" id="settingsPanel">
    <label>API Token <span class="token-saved" id="tokenSaved">сохранён</span></label>
    <input type="password" id="apiToken" placeholder="вставьте токен от llmgtw">

    <label>Модель</label>
    <select id="model">
        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 — быстрый</option>
        <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5 — баланс</option>
        <option value="claude-opus-4-5-20251101">Claude Opus 4.5 — умный</option>
    </select>

    <label>Max tokens</label>
    <input type="number" id="maxTokens" value="2048" min="64" max="8192">
</div>

<div id="chat">
    <div class="welcome" id="welcome">
        <div class="icon">⚡</div>
        <h2>HH TextGen</h2>
        <p>Чат с Claude через корпоративный gateway. Работает из браузера — запросы идут с вашей машины.</p>
        <p style="font-size:12px; margin-top:8px;">Откройте настройки ⚙ и вставьте токен</p>
    </div>
</div>

<div class="input-area">
    <div class="input-row">
        <textarea id="prompt" rows="1" placeholder="Напишите сообщение..."></textarea>
        <button id="sendBtn" onclick="send()">→</button>
    </div>
</div>

<script>
const GATEWAY = 'https://llmgtw.hhdev.ru/proxy/anthropic/v1/messages';
let messages = [];
let busy = false;

// Persist token in localStorage
const tokenInput = document.getElementById('apiToken');
const savedToken = localStorage.getItem('hh_token');
if (savedToken) {
    tokenInput.value = savedToken;
}
tokenInput.addEventListener('input', () => {
    localStorage.setItem('hh_token', tokenInput.value);
    const badge = document.getElementById('tokenSaved');
    badge.style.display = 'inline';
    setTimeout(() => badge.style.display = 'none', 2000);
});

// Auto-resize textarea
const prompt = document.getElementById('prompt');
prompt.addEventListener('input', () => {
    prompt.style.height = 'auto';
    prompt.style.height = Math.min(prompt.scrollHeight, 160) + 'px';
});
prompt.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('open');
}

function addMessage(role, text, meta) {
    const welcome = document.getElementById('welcome');
    if (welcome) welcome.remove();

    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text;
    if (meta) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.textContent = meta;
        div.appendChild(metaDiv);
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

function showTyping() {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.textContent = 'Claude думает';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function removeTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

async function send() {
    if (busy) return;

    const token = tokenInput.value.trim();
    if (!token) {
        toggleSettings();
        tokenInput.focus();
        return;
    }

    const text = prompt.value.trim();
    if (!text) return;

    prompt.value = '';
    prompt.style.height = 'auto';
    document.getElementById('sendBtn').disabled = true;
    busy = true;

    addMessage('user', text);
    messages.push({ role: 'user', content: text });

    showTyping();

    try {
        const t0 = performance.now();
        const resp = await fetch(GATEWAY, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': token,
                'anthropic-version': '2023-06-01',
            },
            body: JSON.stringify({
                model: document.getElementById('model').value,
                max_tokens: parseInt(document.getElementById('maxTokens').value) || 2048,
                messages: messages,
            }),
        });

        const elapsed = ((performance.now() - t0) / 1000).toFixed(1);

        if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${errText.substring(0, 200)}`);
        }

        const data = await resp.json();
        const reply = data.content?.[0]?.text || '(пустой ответ)';
        const usage = data.usage || {};
        const meta = `${data.model} · ${usage.input_tokens}→${usage.output_tokens} tok · ${elapsed}s`;

        removeTyping();
        addMessage('assistant', reply, meta);
        messages.push({ role: 'assistant', content: reply });

    } catch (err) {
        removeTyping();
        let errorMsg = err.message;
        if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
            errorMsg = 'Сеть недоступна или CORS заблокирован. Убедитесь, что вы в корп-сети и gateway принимает запросы из браузера.';
        }
        addMessage('error', errorMsg);
        // Remove last user message from history on error
        messages.pop();
    } finally {
        busy = false;
        document.getElementById('sendBtn').disabled = false;
        prompt.focus();
    }
}

// Register service worker for PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>

</body>
</html>
